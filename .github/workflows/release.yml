name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v0.1.1)'
        required: true
        type: string
      publish:
        description: 'Publish to npm'
        required: false
        type: boolean
        default: true

permissions:
  id-token: write
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ inputs.tag || github.ref_name }}
      PUBLISH: ${{ inputs.publish }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog generation
          ref: ${{ inputs.tag || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.2
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Clean build outputs
        run: pnpm run clean

      - name: Build all packages
        run: pnpm run build

      - name: Run unit tests
        run: pnpm run test:unit

      - name: Run E2E tests (best-effort)
        continue-on-error: true
        run: pnpm run test:e2e

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git tag --sort=-v:refname | grep -v "^${RELEASE_TAG}$" | head -n 1)
          
          # If no previous tag, use initial commit
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          
          # Generate changelog from conventional commits
          echo "## Changes in ${RELEASE_TAG}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          # Group commits by type
          echo "### Features" >> RELEASE_NOTES.md
          git log ${PREV_TAG}..HEAD --pretty=format:"%s" --grep="^feat" >> RELEASE_NOTES.md || echo "None" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          echo "### Bug Fixes" >> RELEASE_NOTES.md
          git log ${PREV_TAG}..HEAD --pretty=format:"%s" --grep="^fix" >> RELEASE_NOTES.md || echo "None" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          echo "### Other Changes" >> RELEASE_NOTES.md
          git log ${PREV_TAG}..HEAD --pretty=format:"%s" --grep="^chore\|^docs\|^refactor\|^test" >> RELEASE_NOTES.md || echo "None" >> RELEASE_NOTES.md
          
          cat RELEASE_NOTES.md

      - name: Publish packages
        id: publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PUBLISH="${PUBLISH:-true}"
          if [ "${PUBLISH}" != "true" ]; then
            echo "Publish disabled; skipping npm publish."
            echo "published=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -z "${NODE_AUTH_TOKEN}" ]; then
            echo "NPM_TOKEN secret is not set; skipping npm publish."
            echo "published=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          node scripts/publish-workspaces.mjs --no-provenance
          echo "published=true" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: ${{ steps.publish.outputs.published == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const releaseNotes = fs.readFileSync('RELEASE_NOTES.md', 'utf8');
            
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: process.env.RELEASE_TAG,
              name: process.env.RELEASE_TAG,
              body: releaseNotes,
              draft: false,
              prerelease: false
            });
